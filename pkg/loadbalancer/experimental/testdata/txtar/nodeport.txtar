# Upsert objects
upsert_service service.yaml
upsert_endpoints endpointslice.yaml

cmp_services -wait=1s service.table
cmp_frontends -wait=1s frontends.table
cmp_backends -wait=1s backends.table

# Wait for reconciliation
wait_for_reconciliation
write_maps actual.maps
cmp actual.maps expected.maps

# Delete
delete_service service.yaml
delete_endpoints endpointslice.yaml

cmp_services -wait=1s service_empty.table
wait_for_reconciliation
write_maps actual.maps
cmp actual.maps empty.maps

# ------------------------------------------------------

-- service_empty.table --
Name

-- service.table --
Name       Source
test/echo  k8s2

-- frontends.table --
Address              Type       ServiceName  PortName
10.96.50.104:80/TCP  ClusterIP  test/echo    http

-- backends.table --
Address             State    Instances          NodeName           ZoneID
10.244.1.1:80/TCP   active   test/echo (http)   nodeport-worker    0
10.244.1.2:80/TCP   active   test/echo (http)   nodeport-worker    0
10.244.1.3:80/TCP   active   test/echo (http)   nodeport-worker    0
10.244.1.4:80/TCP   active   test/echo (http)   nodeport-worker    0
10.244.1.5:80/TCP   active   test/echo (http)   nodeport-worker    0
10.244.1.6:80/TCP   active   test/echo (http)   nodeport-worker    0
10.244.1.7:80/TCP   active   test/echo (http)   nodeport-worker2   0
10.244.1.8:80/TCP   active   test/echo (http)   nodeport-worker2   0
10.244.1.9:80/TCP   active   test/echo (http)   nodeport-worker2   0

-- service.yaml --
apiVersion: v1
kind: Service
metadata:
  name: echo
  namespace: test
  resourceVersion: "1"
  uid: a49fe99c-3564-4754-acc4-780f2331a49b
spec:
  clusterIP: 10.96.50.104
  clusterIPs:
  - 10.96.50.104
  ports:
  - name: http
    nodePort: 30781
    port: 80
    protocol: TCP
    targetPort: 80
  selector:
    name: echo
  type: NodePort
status:
  loadBalancer: {}

-- endpointslice.yaml --
apiVersion: discovery.k8s.io/v1
kind: EndpointSlice
metadata:
  annotations:
  creationTimestamp: "2022-09-13T11:11:26Z"
  generateName: echo-
  generation: 3
  labels:
    endpointslice.kubernetes.io/managed-by: endpointslice-controller.k8s.io
    kubernetes.io/service-name: echo
  name: echo-kvlm2
  namespace: test
  resourceVersion: "797"
  uid: d1f517f6-ab88-4c76-9bd0-4906a17cdd75
addressType: IPv4
endpoints:
- addresses:
  - 10.244.1.1
  nodeName: nodeport-worker
- addresses:
  - 10.244.1.2
  nodeName: nodeport-worker
- addresses:
  - 10.244.1.3
  nodeName: nodeport-worker
- addresses:
  - 10.244.1.4
  nodeName: nodeport-worker
- addresses:
  - 10.244.1.5
  nodeName: nodeport-worker
- addresses:
  - 10.244.1.6
  nodeName: nodeport-worker
- addresses:
  - 10.244.1.7
  nodeName: nodeport-worker2
- addresses:
  - 10.244.1.8
  nodeName: nodeport-worker2
- addresses:
  - 10.244.1.9
  nodeName: nodeport-worker2
ports:
- name: http
  port: 80
  protocol: TCP

  
-- empty.maps --

-- expected.maps --
BE: ID=1 ADDR=10.244.1.1:80 STATE=active
BE: ID=2 ADDR=10.244.1.2:80 STATE=active
BE: ID=3 ADDR=10.244.1.3:80 STATE=active
BE: ID=4 ADDR=10.244.1.4:80 STATE=active
BE: ID=5 ADDR=10.244.1.5:80 STATE=active
BE: ID=6 ADDR=10.244.1.6:80 STATE=active
BE: ID=7 ADDR=10.244.1.7:80 STATE=active
BE: ID=8 ADDR=10.244.1.8:80 STATE=active
BE: ID=9 ADDR=10.244.1.9:80 STATE=active
REV: ID=1 ADDR=10.96.50.104:80
SVC: ID=1 ADDR=10.96.50.104:80 SLOT=0 BEID=0 COUNT=9 QCOUNT=0 FLAGS=ClusterIP+non-routable
SVC: ID=1 ADDR=10.96.50.104:80 SLOT=1 BEID=1 COUNT=0 QCOUNT=0 FLAGS=ClusterIP+non-routable
SVC: ID=1 ADDR=10.96.50.104:80 SLOT=2 BEID=2 COUNT=0 QCOUNT=0 FLAGS=ClusterIP+non-routable
SVC: ID=1 ADDR=10.96.50.104:80 SLOT=3 BEID=3 COUNT=0 QCOUNT=0 FLAGS=ClusterIP+non-routable
SVC: ID=1 ADDR=10.96.50.104:80 SLOT=4 BEID=4 COUNT=0 QCOUNT=0 FLAGS=ClusterIP+non-routable
SVC: ID=1 ADDR=10.96.50.104:80 SLOT=5 BEID=5 COUNT=0 QCOUNT=0 FLAGS=ClusterIP+non-routable
SVC: ID=1 ADDR=10.96.50.104:80 SLOT=6 BEID=6 COUNT=0 QCOUNT=0 FLAGS=ClusterIP+non-routable
SVC: ID=1 ADDR=10.96.50.104:80 SLOT=7 BEID=7 COUNT=0 QCOUNT=0 FLAGS=ClusterIP+non-routable
SVC: ID=1 ADDR=10.96.50.104:80 SLOT=8 BEID=8 COUNT=0 QCOUNT=0 FLAGS=ClusterIP+non-routable
SVC: ID=1 ADDR=10.96.50.104:80 SLOT=9 BEID=9 COUNT=0 QCOUNT=0 FLAGS=ClusterIP+non-routable
